{% if user.user == "SeRvEr" %}
{% include "layouts/panel_admin.html" %}
{% elif user.user == "Sala_Situacional" %}
{% include "layouts/panel_sala_situacional.html" %}
{% elif user.user == "Comandancia" or user.user == "2dacomandancia" %}
{% include "layouts/panel_comandancia.html" %}
{% elif user.user == "Mecanica_01"%}
{% include "layouts/panel_mecanica.html" %}
{% elif user.user == "Operaciones01"%}
{% include "layouts/panel_operaciones.html" %}
{% elif user.user == "Rescate03"%}
{% include "layouts/panel_rescate.html" %}
{% elif user.user == "Grumae02"%}
{% include "layouts/panel_grumae.html" %}
{% elif user.user == "Prehospitalaria04"%}
{% include "layouts/panel_prehospitalaria.html" %}
{% elif user.user == "Prevencion05"%}
{% include "layouts/panel_prevencion.html" %}
{% endif %}

{% load historial_filters %}
{% load static %}

{% block content %}

<style>
/* Estilos para filas clickeables */
.table-hover tbody tr {
    cursor: pointer;
    transition: all 0.2s ease;
}

.table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.1) !important;
    transform: translateY(-1px);
}

/* Modal personalizada */
.detalle-modal .modal-content {
    border-radius: 12px;
    border: none;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.detalle-modal .modal-header {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    border-radius: 12px 12px 0 0;
    border: none;
}

.detalle-badge {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
}

.info-item {
    border-left: 4px solid #007bff;
    padding-left: 1rem;
    margin-bottom: 1rem;
}

.info-item.success {
    border-left-color: #28a745;
}

.info-item.warning {
    border-left-color: #ffc107;
}

.info-item.danger {
    border-left-color: #dc3545;
}
</style>

<div class="general-dashboard">
  <div class="div-user-name username-space">
    <h3 class="division-title">Historial de movimientos</h3>
    <section class="user-name">
      <p>{{ jerarquia }} {{ nombres }} {{ apellidos }} / <b id="usuario">{{ user.user }}</b></p>
      <svg width="30px" height="30px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
        <g id="SVGRepo_iconCarrier">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M12.0001 1.25C9.37678 1.25 7.25013 3.37665 7.25013 6C7.25013 8.62335 9.37678 10.75 12.0001 10.75C14.6235 10.75 16.7501 8.62335 16.7501 6C16.7501 3.37665 14.6235 1.25 12.0001 1.25ZM8.75013 6C8.75013 4.20507 10.2052 2.75 12.0001 2.75C13.7951 2.75 15.2501 4.20507 15.2501 6C15.2501 7.79493 13.7951 9.25 12.0001 9.25C10.2052 9.25 8.75013 7.79493 8.75013 6Z"
            fill="#000000"></path>
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M12.0001 12.25C9.68658 12.25 7.55506 12.7759 5.97558 13.6643C4.41962 14.5396 3.25013 15.8661 3.25013 17.5L3.25007 17.602C3.24894 18.7638 3.24752 20.222 4.52655 21.2635C5.15602 21.7761 6.03661 22.1406 7.22634 22.3815C8.4194 22.6229 9.97436 22.75 12.0001 22.75C14.0259 22.75 15.5809 22.6229 16.7739 22.3815C17.9637 22.1406 18.8443 21.7761 19.4737 21.2635C20.7527 20.222 20.7513 18.7638 20.7502 17.602L20.7501 17.5C20.7501 15.8661 19.5807 14.5396 18.0247 13.6643C16.4452 12.7759 14.3137 12.25 12.0001 12.25ZM4.75013 17.5C4.75013 16.6487 5.37151 15.7251 6.71098 14.9717C8.02693 14.2315 9.89541 13.75 12.0001 13.75C14.1049 13.75 15.9733 14.2315 17.2893 14.9717C18.6288 15.7251 19.2501 16.6487 19.2501 17.5C19.2501 18.8078 19.2098 19.544 18.5265 20.1004C18.156 20.4022 17.5366 20.6967 16.4763 20.9113C15.4194 21.1252 13.9744 21.25 12.0001 21.25C10.0259 21.25 8.58087 21.1252 7.52393 20.9113C6.46366 20.6967 5.84425 20.4022 5.47372 20.1004C4.79045 19.544 4.75013 18.8078 4.75013 17.5Z"
            fill="#000000"></path>
        </g>
      </svg>
    </section>
  </div>
</div>

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <!-- Botón de filtros -->
        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosCollapse">
            <i class="fas fa-filter me-2"></i>Filtros
        </button>
    </div>

    <!-- Panel de Filtros -->
    <div class="collapse mb-4" id="filtrosCollapse">
        <div class="card shadow">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="unidad" class="form-label">Filtrar por Unidad</label>
                        <select name="unidad" id="unidad" class="form-select">
                            <option value="todas" {% if not unidad_seleccionada or unidad_seleccionada == 'todas' %}selected{% endif %}>
                                Todas las unidades
                            </option>
                            {% for unidad in unidades %}
                            <option value="{{ unidad.id }}" {% if unidad_seleccionada == unidad.id|stringformat:"s" %}selected{% endif %}>
                                {{ unidad.nombre_unidad }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="tipo" class="form-label">Tipo de Movimiento</label>
                        <select name="tipo" id="tipo" class="form-select">
                            <option value="todos" {% if tipo_seleccionado == 'todos' %}selected{% endif %}>Todos los movimientos</option>
                            <option value="devoluciones" {% if tipo_seleccionado == 'devoluciones' %}selected{% endif %}>Solo devoluciones</option>
                            <option value="reasignaciones" {% if tipo_seleccionado == 'reasignaciones' %}selected{% endif %}>Solo reasignaciones</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-success me-2">
                            <i class="fas fa-check me-2"></i>Aplicar Filtros
                        </button>
                        <a href="{% url 'historial-movimientos' %}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Limpiar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Resumen de Filtros Aplicados -->
    {% if unidad_seleccionada and unidad_seleccionada != 'todas' or tipo_seleccionado != 'todos' %}
    <div class="alert alert-danger mb-4">
        <strong style="margin-right: .5rem;">Filtros aplicados:  </strong> 
        {% if unidad_seleccionada and unidad_seleccionada != 'todas' %}
        <span class="badge bg-primary me-2">
            Unidad: {{ unidades|get_unidad_nombre:unidad_seleccionada }}
        </span>
        {% endif %}
        {% if tipo_seleccionado != 'todos' %}
        <span class="badge bg-info me-2">
            Tipo: {{ tipo_seleccionado|title }}
        </span>
        {% endif %}
        <a href="{% url 'historial-movimientos' %}" class="btn btn-sm btn-outline-danger ms-2">
            <i class="fas fa-times me-1"></i>Quitar filtros
        </a>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-lg-12" style="margin: 0 auto; width: 95%; overflow: hidden;">
            <!-- Pestañas -->
            <ul class="nav nav-tabs" style="margin: 0 auto; max-width: 100%; position:initial;" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="devoluciones-tab" data-bs-toggle="tab" 
                            data-bs-target="#devoluciones" type="button" role="tab">
                        <i class="fas fa-undo-alt me-2"></i>Devoluciones
                        <span class="badge bg-primary ms-2">{{ devoluciones.count }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reasignaciones-tab" data-bs-toggle="tab" 
                            data-bs-target="#reasignaciones" type="button" role="tab">
                        <i class="fas fa-exchange-alt me-2"></i>Reasignaciones
                        <span class="badge bg-info ms-2">{{ reasignaciones.count }}</span>
                    </button>
                </li>
            </ul>

            <!-- Contenido de pestañas -->
            <div class="tab-content" id="myTabContent">
                <!-- Devoluciones -->
                <div class="tab-pane fade show active" id="devoluciones" role="tabpanel">
                    <div class="card shadow mb-4">
                        <div class="card-body">
                            {% if devoluciones %}
                            <div class="table-responsive-sm">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="fixed-width">Herramienta</th>
                                            <th class="fixed-width">Unidad</th>
                                            <th class="fixed-width">Cantidad</th>
                                            <th class="fixed-width">Fecha Devolución</th>
                                            <th class="fixed-width">Recibido por</th>
                                            <th class="fixed-width">Observaciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for devolucion in devoluciones %}
                                        <tr class="clickable-row" data-bs-toggle="modal" data-bs-target="#modalDevolucion{{ devolucion.id }}">
                                            <td class="fixed-width">{{ devolucion.asignacion.herramienta.nombre }}</td>
                                            <td class="fixed-width">
                                                <span class="badge bg-secondary">
                                                    {{ devolucion.asignacion.unidad.nombre_unidad }}
                                                </span>
                                            </td>
                                            <td class="text-center fixed-width">
                                                <span class="badge bg-success">{{ devolucion.cantidad }}</span>
                                            </td>
                                            <td class="fixed-width">{{ devolucion.fecha_devolucion|date:"d/m/Y H:i" }}</td>
                                            <td class="fixed-width">{{ devolucion.recibido_por.jerarquia }} {{ devolucion.recibido_por.nombres }} {{ devolucion.recibido_por.apellidos }}</td>
                                            <td class="fixed-width">{{ devolucion.observaciones|default:"-" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <h5 class="text-muted">No hay registros de devoluciones</h5>
                                <p class="text-muted">No se encontraron devoluciones con los filtros aplicados</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Reasignaciones -->
                <div class="tab-pane fade" id="reasignaciones" role="tabpanel">
                    <div class="card shadow mb-4">
                        <div class="card-body">
                            {% if reasignaciones %}
                            <div class="table-responsive-sm">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="fixed-width">Herramienta</th>
                                            <th class="fixed-width">Unidad Origen</th>
                                            <th class="fixed-width">Unidad Destino</th>
                                            <th class="fixed-width">Cantidad</th>
                                            <th class="fixed-width">Fecha Reasignación</th>
                                            <th class="fixed-width">Responsable</th>
                                            <th class="fixed-width">Observaciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for reasignacion in reasignaciones %}
                                        <tr class="clickable-row" data-bs-toggle="modal" data-bs-target="#modalReasignacion{{ reasignacion.id }}">
                                            <td class="fixed-width">{{ reasignacion.herramienta.nombre }}</td>
                                            <td class="fixed-width">
                                                <span class="badge bg-danger text-white">
                                                    {{ reasignacion.unidad_origen.nombre_unidad }}
                                                </span>
                                            </td>
                                            <td class="fixed-width">
                                                <span class="badge bg-success">
                                                    {{ reasignacion.unidad_destino.nombre_unidad }}
                                                </span>
                                            </td>
                                            <td class="text-center fixed-width">
                                                <span class="badge bg-danger">{{ reasignacion.cantidad }}</span>
                                            </td>
                                            <td class="fixed-width">{{ reasignacion.fecha_reasignacion|date:"d/m/Y H:i" }}</td>
                                            <td class="fixed-width">{{ reasignacion.responsable.jerarquia }} {{ reasignacion.responsable.nombres }} {{ reasignacion.responsable.apellidos }}</td>
                                            <td class="fixed-width">{{ reasignacion.observaciones|default:"-" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-exchange-alt fa-3x mb-3 text-muted"></i>
                                <h5 class="text-muted">No hay registros de reasignaciones</h5>
                                <p class="text-muted">No se encontraron reasignaciones con los filtros aplicados</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-center align-items-center m-3">
        <a href="{% url 'asignacion-unidades' %}" class="btn btn-outline-danger">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>
</div>





<!-- Modales para Devoluciones -->
{% for devolucion in devoluciones %}
<div class="modal fade detalle-modal" id="modalDevolucion{{ devolucion.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-undo-alt me-2"></i>Detalles de Devolución
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item success">
                            <h6 class="text-muted m-0">Herramienta</h6>
                            <p class="h5">{{ devolucion.asignacion.herramienta.nombre }}</p>
                            <small class="text-muted">Categoría: {{ devolucion.asignacion.herramienta.categoria }}</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item warning">
                            <h6 class="text-muted m-0">Cantidad Devuelta</h6>
                            <p class="h5">{{ devolucion.cantidad }} unidades</p>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item">
                            <h6 class="text-muted m-0">Unidad</h6>
                            <span class="badge bg-primary detalle-badge">
                                {{ devolucion.asignacion.unidad.nombre_unidad }}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <h6 class="text-muted m-0">Fecha y Hora</h6>
                            <p>{{ devolucion.fecha_devolucion|date:"d/m/Y H:i" }}</p>
                        </div>
                    </div>
                </div>

                <div class="info-item">
                    <h6 class="text-muted m-0">Recibido por</h6>
                    <p class="h6">{{ devolucion.recibido_por.jerarquia }} {{ devolucion.recibido_por.nombres }} {{ devolucion.recibido_por.apellidos }}</p>
                </div>

                <div class="info-item {% if devolucion.observaciones %}danger{% endif %}">
                    <h6 class="text-muted m-0">Observaciones</h6>
                    <p>{{ devolucion.observaciones|default:"No hay observaciones registradas" }}</p>
                </div>

                <div class="info-item">
                    <h6 class="text-muted m-0">Información Adicional</h6>
                    <div class="small text-muted">
                        <div>Asignado originalmente el: {{ devolucion.asignacion.fecha_asignacion|date:"d/m/Y" }}</div>
                        <div>Estado: {{ devolucion.asignacion.herramienta.get_estado_display }}</div>
                        {% if devolucion.asignacion.herramienta.numero_serie %}
                        <div>N° Serie: {{ devolucion.asignacion.herramienta.numero_serie }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>
{% endfor %}




<!-- Modales para Reasignaciones -->
{% for reasignacion in reasignaciones %}
<div class="modal fade detalle-modal" id="modalReasignacion{{ reasignacion.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>Detalles de Reasignación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item success">
                            <h6 class="text-muted m-0">Herramienta</h6>
                            <p class="h5">{{ reasignacion.herramienta.nombre }}</p>
                            <small class="text-muted">Categoría: {{ reasignacion.herramienta.categoria }}</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item warning">
                            <h6 class="text-muted m-0">Cantidad Reasignada</h6>
                            <p class="h5">{{ reasignacion.cantidad }} unidades</p>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item danger">
                            <h6 class="text-muted m-0">Unidad Origen</h6>
                            <span class="badge bg-danger detalle-badge">
                                {{ reasignacion.unidad_origen.nombre_unidad }}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item success">
                            <h6 class="text-muted m-0">Unidad Destino</h6>
                            <span class="badge bg-success detalle-badge">
                                {{ reasignacion.unidad_destino.nombre_unidad }}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item">
                            <h6 class="text-muted m-0">Fecha y Hora</h6>
                            <p>{{ reasignacion.fecha_reasignacion|date:"d/m/Y H:i" }}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <h6 class="text-muted m-0">Ordenado Por</h6>
                            <p class="h6">{{ reasignacion.responsable.jerarquia }} {{ reasignacion.responsable.nombres }} {{ reasignacion.responsable.apellidos }}</p>
                        </div>
                    </div>
                </div>

                <div class="info-item {% if reasignacion.observaciones %}danger{% endif %}">
                    <h6 class="text-muted m-0">Observaciones</h6>
                    <p>{{ reasignacion.observaciones|default:"No hay observaciones registradas" }}</p>
                </div>

                <div class="info-item">
                    <h6 class="text-muted m-0">Información Adicional</h6>
                    <div class="small text-muted">
                        <div>Estado: {{ reasignacion.herramienta.get_estado_display }}</div>
                        {% if reasignacion.herramienta.numero_serie %}
                        <div>N° Serie: {{ reasignacion.herramienta.numero_serie }}</div>
                        {% endif %}
                        <div>Fecha de registro: {{ reasignacion.fecha_reasignacion|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<script>
// Mostrar automáticamente los filtros si hay alguno aplicado
document.addEventListener('DOMContentLoaded', function() {
    {% if unidad_seleccionada and unidad_seleccionada != 'todas' or tipo_seleccionado != 'todos' %}
    var filtrosCollapse = new bootstrap.Collapse(document.getElementById('filtrosCollapse'), {
        toggle: true
    });
    {% endif %}
    
    // Actualizar contadores en tiempo real
    function updateCounters() {
        document.querySelector('#devoluciones-tab .badge').textContent = {{ devoluciones.count }};
        document.querySelector('#reasignaciones-tab .badge').textContent = {{ reasignaciones.count }};
    }
    updateCounters();
});
</script>
<script>
// Mejorar la experiencia de las filas clickeables
document.addEventListener('DOMContentLoaded', function() {
    // Efecto hover mejorado
    const rows = document.querySelectorAll('.clickable-row');
    
    rows.forEach(row => {
        row.addEventListener('click', function(e) {
            // Evitar que se active si se hace click en un enlace dentro de la fila
            if (e.target.tagName === 'A' || e.target.closest('a')) {
                return;
            }
            
            // Agregar efecto visual
            this.style.backgroundColor = '#e3f2fd';
            setTimeout(() => {
                this.style.backgroundColor = '';
            }, 300);
        });
        
        row.addEventListener('mouseenter', function() {
            this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.boxShadow = 'none';
        });
    });
    
    // Cerrar modales con ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modals = document.querySelectorAll('.modal.show');
            modals.forEach(modal => {
                bootstrap.Modal.getInstance(modal).hide();
            });
        }
    });
});
</script>
{% endblock %}